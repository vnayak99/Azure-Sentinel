{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": ">**NOTE:** This workbook depends on a parser based on a Kusto Function to work as expected [**Corelight**](https://aka.ms/sentinel-Corelight-parser) which is deployed with the Microsoft Sentinel Solution."
      },
      "name": "text - 23"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "c64d5d3d-90c6-484a-ab88-c70652b75b6e",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 86400000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 300000
                },
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2419200000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ],
              "allowCustom": true
            },
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "a076210e-a47c-43c2-97e1-1f663fedbd01",
            "version": "KqlParameterItem/1.0",
            "name": "Sensor",
            "label": "Corelight Sensor",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "union corelight_conn, corelight_conn_red\n| distinct _system_name\n| sort by _system_name",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "timeContextFromParameter": "TimeRange",
            "defaultValue": "value::all",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "value": [
              "value::all"
            ]
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters - 1"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "d723eef6-b3f0-40be-9a56-125421b32619",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Corelight Main Dashboard",
            "subTarget": "corelight_main_dashboard",
            "style": "link"
          },
          {
            "id": "5736d4f4-bd4c-4a49-bea7-00da2bbc7fd9",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Corelight Connections",
            "subTarget": "corelight_connections",
            "style": "link"
          },
          {
            "id": "5336f601-4da3-4da0-8196-332a97636047",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Corelight DNS",
            "subTarget": "corelight_dns",
            "style": "link"
          },
          {
            "id": "b0e6ac55-179e-4fb5-80ff-ec84edb35324",
            "cellValue": "Tab",
            "linkTarget": "parameter",
            "linkLabel": "Corelight HTTP",
            "subTarget": "corelight_http",
            "style": "link"
          }
        ]
      },
      "name": "links - 24"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Corelight Main Dashboard",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union Corelight_v2_*_CL\n| where \"(all values)\" == \"{Sensor}\" or _system_name_s in ({Sensor})\n| where TimeGenerated {TimeRange}\n|make-series Trend = count() on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by _path_s;",
              "size": 0,
              "showAnalytics": true,
              "title": "Sensor Events Timechart",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "areachart"
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "corelight_main_dashboard"
            },
            "name": "Sensor Events Timechart"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union Corelight_v2_*_CL\n| where \"(all values)\" == \"{Sensor}\" or _system_name_s in ({Sensor})\n| where TimeGenerated {TimeRange}\n| summarize Count=count() by _path_s | sort by Count desc",
              "size": 0,
              "showAnalytics": true,
              "title": "Sensor Events Count",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "categoricalbar"
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "corelight_main_dashboard"
            },
            "name": "Sensor Events Count"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "corelight_main_dashboard"
      },
      "name": "corelight_main_dashboard_group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Events",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "(corelight_notice\r\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\r\n//| where note != \"LongConnection::found\" and note != \"SSL::Invalid_Server_Cert\"\r\n//| project-rename Alert = note \r\n| union corelight_suricata_corelight)\r\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\r\n//| where alert_category != \"Not Suspicious Traffic\" and alert_category != \"Attempted Information Leak\" and alert_category != \"Potentially Bad Traffic\"\r\n//| where _path_s == \"notice\"\r\n//| project-rename Alert = alert_category\r\n| extend Category = coalesce(note, alert_category), Alert = coalesce(msg, alert_signature), Severity=coalesce(severity_level, alert_severity, 7.), Type = _path\r\n| extend PartitionKey = case(_path == \"suricata_corelight\", Alert, Category)\r\n| where (isnotempty(uid) or isnotempty(community_id))\r\n| partition hint.strategy=native by PartitionKey\r\n(\r\n  top 10 by TimeGenerated\r\n)\r\n| order by Severity asc, TimeGenerated\r\n\r\n// hack to hide empty columns\r\n| evaluate narrow()\r\n| where isnotempty(Value) and Value != \"##(null)\" or Column == \"_system_name_s\"\r\n| evaluate pivot(Column, any(Value), Row)\r\n\r\n| project-reorder TimeGenerated, Type, Category, Alert, Severity, uid, id_orig_h, id_resp_h, id_resp_p\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Recent Events Summary (10 most recent per message type)",
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "uid",
              "exportParameterName": "Selected_uid",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "events_summary_recent"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union Corelight_v2_*_CL\r\n| where \"(all values)\" == \"{Sensor}\" or _system_name_s in ({Sensor})\r\n| where (isnotempty(\"{Selected_uid}\") and (uid_s == \"{Selected_uid}\" or conn_uids_s contains_cs \"{Selected_uid}\"))\r\n| top 300 by TimeGenerated\r\n// hack to hide empty columns\r\n| evaluate narrow()\r\n| where isnotempty(Value) and Value != \"##(null)\" or Column == \"_system_name_s\"\r\n| evaluate pivot(Column, any(Value), Row)\r\n| project-reorder TimeGenerated, _path_s, id_orig_h_s, id_resp_h_s, id_resp_p_d, _system_name_s\r\n| project-away Row",
              "size": 0,
              "showAnalytics": true,
              "title": "Related paths (select in Events Summary)",
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "_path_s",
              "exportParameterName": "Selected_path",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "labelSettings": [
                  {
                    "columnId": "_path_s",
                    "label": "Path"
                  }
                ]
              }
            },
            "name": "events_related_entries"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "corelight_suricata_corelight\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| summarize alert_count=count() by source_ip=id_orig_h, alert_signature, severity=alert_severity\n| top 10 by alert_count\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Suricata Top Alerts by Source",
              "timeContext": {
                "durationMs": 86400000
              },
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "50",
            "name": "events_suricata_most_hits_src"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "corelight_main_dashboard"
      },
      "name": "tme_events"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Corelight Connections",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union corelight_conn, corelight_conn_red\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where local_resp == true and (proto == \"tcp\" or (proto == \"udp\" and orig_bytes > 0 and resp_bytes > 0))\n| where conn_state != \"S0\"\n| summarize count() by id_resp_h, id_resp_p, service\n| summarize Count=count() by service\n| top 20 by Count\n",
              "size": 3,
              "showAnalytics": true,
              "title": "Local Hosts Seen Offering Services",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "local_host_offering_services"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union corelight_conn, corelight_conn_red\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where proto==\"tcp\" or (proto==\"udp\" and orig_pkts>0 and resp_pkts>0)\n| where conn_state != \"S0\"\n| where local_resp==true\n| summarize Count=count() by portproto=strcat(tostring(toint(id_resp_p)), \"/\", proto)\n| top 15 by Count",
              "size": 3,
              "showAnalytics": true,
              "title": "Top Responder Ports",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "top_responder_ports"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union corelight_conn, corelight_conn_red\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where local_orig == false and local_resp == true\n| where proto==\"tcp\" or (proto==\"udp\" and orig_pkts>0 and resp_pkts>0)\n| where conn_state!=\"S0\"\n| summarize number_of_conns=count(), orig_bytes_sum=sum(orig_bytes) by id_orig_h, service\n| extend orig_data = format_bytes(orig_bytes_sum, 2)\n| order by orig_bytes_sum desc\n| top 20 by orig_bytes_sum desc\n| project-away orig_bytes_sum\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Top Inbound Data Flows by Originator",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "33",
            "name": "top_inbound_by_orig"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union corelight_conn, corelight_conn_red\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where proto == \"tcp\" or (proto == \"udp\" and orig_pkts>0 and resp_pkts>0)\n| where local_orig==true and local_resp==false\n| where conn_state != \"S0\"\n| summarize number_of_conns=count(), orig_bytes_sum=sum(orig_bytes) by id_orig_h, service\n| extend orig_data = format_bytes(orig_bytes_sum, 2)\n| order by orig_bytes_sum desc\n| project-away orig_bytes_sum",
              "size": 0,
              "showAnalytics": true,
              "title": "Top Outbound Data Flows by Originator",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "33",
            "name": "top_outbound_bytes"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union corelight_conn, corelight_conn_red\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where conn_state==\"S0\"\n| summarize Count=count() by id_orig_h, id_resp_p, service\n| order by Count desc",
              "size": 0,
              "showAnalytics": true,
              "title": "Hosts Generating S0 (possible scan) Traffic",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "33",
            "name": "possible_scan_connections"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union corelight_conn, corelight_conn_red\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where proto==\"tcp\" or (proto==\"udp\" and orig_pkts>0 and resp_pkts>0)\n| where conn_state != \"S0\"\n| summarize number_of_conns=count(), orig_bytes_sum=sum(orig_bytes), resp_bytes_sum=sum(resp_bytes) by id_orig_h, id_resp_h, id_resp_p, proto\n| extend total_bytes_sum = orig_bytes_sum + resp_bytes_sum\n| extend total_data = format_bytes(total_bytes_sum, 2)\n| top 20 by total_bytes_sum desc",
              "size": 0,
              "showAnalytics": true,
              "title": "Largest transfers between host/port pairs",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "largest_transfers_by_host_port"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union corelight_conn, corelight_conn_red\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where local_resp == true and conn_state == \"S0\"\n| summarize Count=count() by id_resp_h, id_resp_p, service\n| top 30 by Count",
              "size": 0,
              "showAnalytics": true,
              "title": "Possible Down Services",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "25",
            "name": "possible_down_services"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union corelight_conn, corelight_conn_red\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| summarize Count=count() by history\n| top 20 by Count",
              "size": 0,
              "showAnalytics": true,
              "title": "Monitor Health Asymmetry (All UPPER or lower is bad)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "25",
            "name": "monitor_health_asymmetry"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union corelight_conn, corelight_conn_red\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where local_orig == false and local_resp == false\n| summarize Count=count() by id_orig_h, id_resp_h, id_resp_p, service\n| top 20 by Count",
              "size": 0,
              "showAnalytics": true,
              "title": "Remote to Remote Connections",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "50",
            "name": "remote_to_remote_connections"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "corelight_notice\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where note == \"LongConnection::found\"\n| summarize Count=count(1), arg_max(TimeGenerated, id_orig_h, id_resp_h, id_resp_p, sub, msg) by uid\n| extend seconds=sub\n| top 20 by seconds desc\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Longest Lived Connections, (May have already closed)",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "longest_lived_connections"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "union corelight_conn, corelight_conn_red\n| where TimeGenerated  {TimeRange}\n//| where EventType startswith \"conn\"\n| where isnotempty(service)\n| summarize count() by tostring(service) | take 10",
                    "size": 3,
                    "title": "Top Services",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "visualization": "piechart",
                    "chartSettings": {
                      "showMetrics": false,
                      "showLegend": true,
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 0,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "50",
                  "name": "Top Services"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "union corelight_conn, corelight_conn_red\n| where TimeGenerated  {TimeRange}\n//| where EventType startswith \"conn\"\n| where isnotempty(id_resp_p)\n| extend dstprt = tostring(toint(id_resp_p))\n| summarize Count=count() by dstprt | sort by Count desc |take 10",
                    "size": 3,
                    "title": "Top Responder Ports",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "visualization": "piechart",
                    "chartSettings": {
                      "showMetrics": false,
                      "showLegend": true,
                      "ySettings": {
                        "numberFormatSettings": {
                          "unit": 0,
                          "options": {
                            "style": "decimal",
                            "useGrouping": true
                          }
                        }
                      }
                    }
                  },
                  "customWidth": "50",
                  "name": "Top Responder Ports"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "union corelight_conn, corelight_conn_red\n//| where TimeGenerated  {TimeRange}\n//| where EventType startswith \"conn\"\n//| extend NetworkDirection = case(LocalOrig == true,\"outbound\", LocalOrig == false, \"inbound\",'')\n| where local_orig == true and local_resp == false\n//| where isnotempty(SrcIpAddr) and isnotempty(DstIpAddr) and isnotempty(SrcIpBytes) and isnotempty(DstIpBytes)\n| extend bytes = toint(orig_bytes_d) + toint(resp_bytes_d)\n| summarize Bytes=sum(bytes) by id_orig_h, id_resp_h, proto | sort by Bytes desc | take 15",
                    "size": 0,
                    "title": "Top Outbound Data Flows by Originator Bytes",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "customWidth": "50",
                  "name": "Top Outbound Data Flows by Originator Bytes"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "union corelight_conn, corelight_conn_red\n//| where TimeGenerated  {TimeRange}\n//| where EventType startswith \"conn\"\n//| extend NetworkDirection = case(LocalOrig == true,\"outbound\", LocalOrig == false, \"inbound\",'')\n| where local_orig == false and local_resp == true\n//| where isnotempty(SrcIpAddr) and isnotempty(DstIpAddr) and isnotempty(SrcIpBytes) and isnotempty(DstIpBytes)\n| extend bytes = toint(orig_bytes_d) + toint(resp_bytes_d)\n| summarize Bytes=sum(bytes) by id_orig_h, id_resp_h, proto | sort by Bytes desc | take 15",
                    "size": 0,
                    "title": "Top Inbound Data Flows by Originator Bytes",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "customWidth": "50",
                  "name": "Top Inbound Data Flows by Originator Bytes - Copy"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "union corelight_conn, corelight_conn_red\n//| where EventType startswith \"conn\"\n| where TimeGenerated  {TimeRange} \n| summarize Count=count() by id_orig_h | sort by Count",
                    "size": 3,
                    "title": "Top Originators (sources) by # of connections",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "visualization": "piechart"
                  },
                  "customWidth": "50",
                  "name": "Top Originators (sources) by # of connections"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "union corelight_conn, corelight_conn_red\n//| where EventType startswith \"conn\"\n| where TimeGenerated  {TimeRange} \n| summarize Count=count() by id_resp_h | sort by Count",
                    "size": 3,
                    "title": "Top Responders (destinations) by # of connections",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "visualization": "piechart"
                  },
                  "customWidth": "50",
                  "name": "Top Responders (destinations) by # of connections - Copy"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "union corelight_conn, corelight_conn_red\n//| where EventType startswith \"conn\"\n| where TimeGenerated  {TimeRange}\n| where isnotempty(id_orig_h) and isnotempty(id_resp_h) and isnotempty(service) and isnotempty(id_orig_p) and isnotempty(id_resp_p)\n| summarize Duration=avg(toint(duration)), make_list(id_orig_h), make_list(id_resp_h), make_list(proto) by uid | sort by Duration desc | take 50",
                    "size": 0,
                    "title": "Open/Active Long Lived Connections (requires Long Connections Pkg)",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "sortBy": []
                  },
                  "customWidth": "50",
                  "name": "Open/Active Long Lived Connections (requires Long Connections Pkg)"
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "Tab",
              "comparison": "isEqualTo",
              "value": "deprecated"
            },
            "name": "deprecated_conn"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "corelight_connections"
      },
      "name": "corelight_connections_group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Corelight DNS",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union corelight_dns, corelight_dns_red\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n//| where is_broadcast_b!=true\n| summarize Count=count() by qtype_name\n| top 10 by Count",
              "size": 3,
              "showAnalytics": true,
              "title": "Top Query Types",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "dns_top_query_types"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union corelight_dns, corelight_dns_red\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where (rcode_name==\"NXDOMAIN\" or rcode==3) and qtype_name != \"PTR\"\n| summarize Count=count() by qtype_name\n| top 20 by Count",
              "size": 3,
              "showAnalytics": true,
              "title": "No response DNS query by type",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "dns_nx_by_type"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union corelight_dns, corelight_dns_red\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where id_resp_p == 53 and (rcode_name == \"NXDOMAIN\" or rcode == 3) and qtype_name != \"PTR\"\n| summarize Count=count() by query\n| top 100 by Count",
              "size": 0,
              "showAnalytics": true,
              "title": "Top Queries by Count to Non-Existent Domains",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "33",
            "name": "dns_top_nxdomain_by_count"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union corelight_dns, corelight_dns_red\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where id_resp_p == 53\n| summarize Count=count() by id_orig_h\n| top 20 by Count",
              "size": 0,
              "showAnalytics": true,
              "title": "Top Originators by Count",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "25",
            "name": "dns_top_originators"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union corelight_dns, corelight_dns_red\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where id_resp_p == 53 and qtype_name != \"ptr\"\n| summarize Count=count() by query\n| top 100 by Count",
              "size": 0,
              "showAnalytics": true,
              "title": "Top Queries by Count",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "33",
            "name": "dns_top_queries_by_count"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union corelight_dns, corelight_dns_red\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where id_resp_p==53 and qtype_name==\"PTR\" and (rcode_name==\"NOERROR\" or rcode==0)\n| summarize Count=count() by query\n| top 100 by Count",
              "size": 0,
              "showAnalytics": true,
              "title": "Top Successful Reverse Queries by Count",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "33",
            "name": "dns_top_ptr_by_count"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union corelight_dns, corelight_dns_red\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where id_resp_p == 53 and (rcode_name == \"NXDOMAIN\" or rcode == 3) and qtype_name != \"PTR\"\n| summarize Count=count() by id_orig_h\n| top 20 by Count\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Top Host querying Non-Existent Domains",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "25",
            "name": "dns_top_hosts_querying_nxdomain"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union corelight_dns, corelight_dns_red\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where id_resp_p == 53 and qtype_name == \"PTR\" and (rcode_name == \"NXDOMAIN\" or rcode == 3)\n| summarize Count=count() by query\n| top 100 by Count",
              "size": 0,
              "showAnalytics": true,
              "title": "Top Reverse Queries by Count to Non-Existent Domains",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "33",
            "name": "dns_top_ptr_nxdomain"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "union corelight_dns, corelight_dns_red\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| extend query_length = string_size(query)\n| summarize Count=count() by id_orig_h, query_length, query\n| order by query_length desc",
              "size": 0,
              "showAnalytics": true,
              "title": "DNS by Query Length",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "dns_by_query_length"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "corelight_dns"
      },
      "name": "corelight_dns_group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Corelight Files",
        "items": [
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Deprecated files queries",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "corelight_files\n| where TimeGenerated  {TimeRange}\n//| where EventType startswith \"files\"\n| where isnotempty(mime_type)\n| where mime_type != \"application/pkix-cert\"\n| summarize Count=count() by mime_type | sort by Count desc | take 20\n",
                    "size": 0,
                    "title": "Top 20 Mime Types by File Count",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "visualization": "categoricalbar"
                  },
                  "name": "Top 20 Mime Types by File Count"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "corelight_files\n| where TimeGenerated  {TimeRange}\n//| where EventType startswith \"files\"\n| where isnotempty(mime_type)\n| where mime_type != \"application/pkix-cert\"\n| summarize [\"File Count\"]=count() by source | sort by [\"File Count\"] desc | take 15\n",
                    "size": 0,
                    "title": "Top File Protocols by File Count",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "visualization": "categoricalbar"
                  },
                  "name": "Top File Protocols by File Count"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "corelight_files\n//| where EventType startswith \"files\"\n| where isnotempty(mime_type)\n| where mime_type != \"application/pkix-cert\"\n| extend NetworkDirection = case(local_orig == \"true\", \"outbound\", local_orig == \"false\", \"inbound\", \"\" )\n|make-series [\"Files Sent\"]=countif(NetworkDirection==\"outbound\"), [\"Files Received\"]=countif(NetworkDirection==\"inbound\") on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by _path | project [\"Files Sent\"], [\"Files Received\"], TimeGenerated",
                    "size": 0,
                    "title": "File Flow - # of Files",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "visualization": "areachart",
                    "tileSettings": {
                      "showBorder": false
                    },
                    "graphSettings": {
                      "type": 0
                    }
                  },
                  "customWidth": "50",
                  "name": "File Flow - # of Files"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "corelight_files\n//| where EventType startswith \"files\"\n| where isnotempty(mime_type)\n| where mime_type != \"application/pkix-cert\"\n//| extend NetworkDirection = case(local_orig == true, \"outbound\", local_orig == false, \"inbound\", \"\" )\n// fixme: drop _d\n|make-series [\"Bytes Sent\"]=sumif(toint(seen_bytes_d), local_orig == true), [\"Bytes Received\"]=sumif(toint(seen_bytes_d),local_orig == false) on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by EventType",
                    "size": 0,
                    "title": "File Flow - Bytes",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "visualization": "areachart",
                    "tileSettings": {
                      "showBorder": false
                    },
                    "graphSettings": {
                      "type": 0
                    }
                  },
                  "customWidth": "50",
                  "name": "File Flow - Bytes"
                }
              ]
            },
            "name": "deprecated_files"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "corelight_files"
      },
      "name": "corelight_files_group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Corelight HTTP",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "corelight_http\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where host != \"control\"\n| summarize distinct_referrers=count_distinct(referrer)",
              "size": 3,
              "showAnalytics": true,
              "title": "Distinct Referrers",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "card",
              "textSettings": {
                "style": "bignumber"
              }
            },
            "customWidth": "16",
            "name": "http_distinct_referrers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "corelight_http\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where host != \"control\"\n| summarize distinct_user_agents=count_distinct(user_agent)",
              "size": 3,
              "showAnalytics": true,
              "title": "Distinct User Agents",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "card",
              "textSettings": {
                "style": "bignumber"
              }
            },
            "customWidth": "16",
            "name": "http_distinct_user_agents"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "corelight_http\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where host != \"control\"\n| summarize count_distinct(host)",
              "size": 3,
              "showAnalytics": true,
              "title": "Distinct Hosts",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "card",
              "textSettings": {
                "style": "bignumber"
              }
            },
            "customWidth": "16",
            "name": "http_distinct_hosts"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "corelight_http\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where host != \"control\"\n| summarize distinct_connections=count_distinct(uid)",
              "size": 3,
              "showAnalytics": true,
              "title": "Distinct Connections",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "card",
              "textSettings": {
                "style": "bignumber"
              }
            },
            "customWidth": "16",
            "name": "http_distinct_connections"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "corelight_http\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where host != \"control\"\n| summarize avg = format_bytes(avg(response_body_len), 2)",
              "size": 3,
              "showAnalytics": true,
              "title": "Average Body Length",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "card",
              "textSettings": {
                "style": "bignumber"
              }
            },
            "customWidth": "16",
            "name": "http_avg_response_len"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "corelight_http\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where host != \"control\"\n| extend ua_length = strlen(user_agent)\n| summarize avg_ua_length = round(avg(ua_length))",
              "size": 3,
              "showAnalytics": true,
              "title": "Average User Agent Length",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "card",
              "textSettings": {
                "style": "bignumber"
              }
            },
            "customWidth": "16",
            "name": "http_avg_ua_length"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "corelight_http\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where host != \"control\"\n| summarize Count=count() by host\n| top 10 by Count",
              "size": 0,
              "showAnalytics": true,
              "title": "Top Host Headers by Count",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "Count",
                    "sortOrder": 1
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "Count",
                  "sortOrder": 1
                }
              ]
            },
            "customWidth": "33",
            "name": "http_top_hosts"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "corelight_http\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where host != \"control\"\n| summarize Count=count() by status_msg\n| top 10 by Count",
              "size": 3,
              "showAnalytics": true,
              "title": "HTTP Status Code Breakdown",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "piechart"
            },
            "customWidth": "33",
            "name": "http_status_code_chart"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "corelight_http\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where host != \"control\"\n| summarize Count=count() by id_orig_h\n| top 10 by Count",
              "size": 0,
              "showAnalytics": true,
              "title": "Top Originators",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "33",
            "name": "http_top_originators"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "corelight_http\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where host != \"control\"\n| summarize Count=count() by user_agent\n| top 10 by Count asc",
              "size": 0,
              "showAnalytics": true,
              "title": "Rare User Agents",
              "timeContext": {
                "durationMs": 86400000
              },
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "70",
            "name": "http_rare_ua"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "corelight_http\n| where \"(all values)\" == \"{Sensor}\" or _system_name in ({Sensor})\n| where host != \"control\"\n| summarize Count=count() by host, status_code\n| top 10 by Count asc",
              "size": 0,
              "showAnalytics": true,
              "title": "Rare Host Headers",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "25",
            "name": "http_rare_hosts"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "corelight_http"
      },
      "name": "corelight_http_group"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Corelight Software",
        "items": [
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Deprecated software queries",
              "items": [
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "corelight_software\n//| where EventType startswith \"software\"\n| where TimeGenerated  {TimeRange}\n//| where isnotempty(SoftwareType)\n| summarize Count=count() by name | sort by Count | take 20\n",
                    "size": 0,
                    "title": "Top Software",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "visualization": "categoricalbar"
                  },
                  "name": "Top Software"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "corelight_software\n//| where TimeGenerated  {TimeRange}\n//| where EventType startswith \"software\"\n| where isnotempty(software_type)\n| summarize Count=count() by name, unparsed_version | sort by Count",
                    "size": 0,
                    "title": "Top Software Versions",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Name",
                          "formatter": 5
                        }
                      ],
                      "hierarchySettings": {
                        "treeType": 1,
                        "groupBy": [
                          "Name"
                        ],
                        "expandTopLevel": true
                      }
                    }
                  },
                  "customWidth": "50",
                  "name": "Top Software Versions"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "corelight_software\n//| where EventType startswith \"software\"\n| where isnotempty(software_type)\n| summarize Count=count() by software_type | sort by Count",
                    "size": 0,
                    "title": "Top Software Types",
                    "timeContextFromParameter": "TimeRange",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "gridSettings": {
                      "formatters": [
                        {
                          "columnMatch": "Name",
                          "formatter": 5
                        }
                      ],
                      "hierarchySettings": {
                        "treeType": 1,
                        "groupBy": [
                          "Name"
                        ],
                        "expandTopLevel": true
                      }
                    }
                  },
                  "customWidth": "50",
                  "name": "Top Software Types"
                }
              ]
            },
            "name": "deprecated_software"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "corelight_software"
      },
      "name": "corelight_software_group"
    }
  ],
  "fallbackResourceIds": [],
  "fromTemplateId": "sentinel-CorelightWorkbook",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
